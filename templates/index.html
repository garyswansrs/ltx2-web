<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LTX-2 Video Generation</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-hue: 265;
            --accent-hue: 340;
            --bg-dark: #0a0a0f;
            --bg-card: #12121a;
            --bg-hover: #1a1a25;
            --bg-input: #0d0d14;
            --border-color: #2a2a3a;
            --border-focus: #a855f7;
            --text-primary: #f0f0f5;
            --text-secondary: #9090a5;
            --text-muted: #606075;
            --accent-purple: #a855f7;
            --accent-pink: #ec4899;
            --accent-orange: #f97316;
            --accent-green: #22c55e;
            --accent-red: #ef4444;
            --accent-yellow: #f59e0b;
            --accent-gradient: linear-gradient(135deg, #a855f7 0%, #ec4899 50%, #f97316 100%);
            --glow-purple: 0 0 30px rgba(168, 85, 247, 0.3);
            --glow-pink: 0 0 30px rgba(236, 72, 153, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 2rem 0 3rem;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 100%;
            background: radial-gradient(ellipse at center, rgba(168, 85, 247, 0.15) 0%, transparent 70%);
            pointer-events: none;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 700;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .header .links {
            margin-top: 1rem;
        }

        .header .links a {
            color: var(--accent-purple);
            text-decoration: none;
            margin: 0 0.5rem;
            transition: color 0.3s;
        }

        .header .links a:hover {
            color: var(--accent-pink);
        }

        /* Main Layout */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card h3 {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 0.75rem;
            color: var(--text-secondary);
        }

        /* Forms */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: var(--glow-purple);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-hint {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .btn-primary {
            background: var(--accent-gradient);
            color: white;
        }

        .btn-primary:hover {
            box-shadow: var(--glow-purple), var(--glow-pink);
            transform: translateY(-2px);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: var(--bg-hover);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            border-color: var(--accent-purple);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .btn-block {
            width: 100%;
        }

        .btn-group {
            display: flex;
            gap: 0.5rem;
        }

        /* Status */
        .status {
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
        }

        .status-success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: var(--accent-green);
        }

        .status-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--accent-red);
        }

        .status-warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: var(--accent-yellow);
        }

        .status-info {
            background: rgba(168, 85, 247, 0.1);
            border: 1px solid rgba(168, 85, 247, 0.3);
            color: var(--accent-purple);
        }

        /* Progress - Multi-stage */
        .progress-container {
            margin: 1rem 0;
        }

        .stages-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .stage-item {
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem;
            transition: all 0.3s ease;
        }

        .stage-item.active {
            border-color: var(--accent);
            box-shadow: 0 0 12px rgba(168, 85, 247, 0.2);
        }

        .stage-item.completed {
            border-color: #22c55e;
        }

        .stage-item.pending {
            opacity: 0.5;
        }

        .stage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .stage-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stage-status {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .stage-status.active {
            color: var(--accent);
        }

        .stage-status.completed {
            color: #22c55e;
        }

        .stage-bar {
            height: 6px;
            background: var(--bg-hover);
            border-radius: 3px;
            overflow: hidden;
        }

        .stage-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.2s ease;
        }

        .stage-fill.loading {
            background: linear-gradient(90deg, #f59e0b, #f97316);
        }

        .stage-fill.stage1 {
            background: linear-gradient(90deg, #a855f7, #ec4899);
        }

        .stage-fill.stage2 {
            background: linear-gradient(90deg, #3b82f6, #06b6d4);
        }

        .stage-fill.encoding {
            background: linear-gradient(90deg, #22c55e, #10b981);
        }

        .stage-detail {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.35rem;
            text-align: right;
        }

        /* Legacy progress (for fallback) */
        .progress-bar {
            height: 8px;
            background: var(--bg-hover);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent-gradient);
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .progress-text {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            text-align: center;
        }

        /* Models List */
        .model-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            margin-bottom: 0.75rem;
            transition: all 0.3s ease;
        }

        .model-item:hover {
            border-color: var(--accent-purple);
        }

        .model-info h4 {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .model-info p {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .model-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-ready {
            background: rgba(34, 197, 94, 0.2);
            color: var(--accent-green);
        }

        .badge-missing {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-red);
        }

        .badge-downloading {
            background: rgba(245, 158, 11, 0.2);
            color: var(--accent-yellow);
        }

        /* Video Output */
        .video-container {
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            aspect-ratio: 16 / 9;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .video-container video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .video-placeholder {
            text-align: center;
            color: var(--text-muted);
        }

        .video-placeholder svg {
            width: 64px;
            height: 64px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Queue */
        .queue-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: var(--bg-dark);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .queue-item .job-id {
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-secondary);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
        }

        .tab {
            flex: 1;
            padding: 0.75rem;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .tab:hover {
            background: var(--bg-hover);
        }

        .tab.active {
            background: var(--accent-gradient);
            color: white;
        }

        /* Collapsible */
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 1rem;
            background: var(--bg-dark);
            border-radius: 10px;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        .collapsible-header:hover {
            background: var(--bg-hover);
        }

        .collapsible-content {
            display: none;
            padding: 1rem;
        }

        .collapsible-content.show {
            display: block;
        }

        /* Checkbox styling */
        .form-group label input[type="checkbox"] {
            width: auto;
            height: auto;
            accent-color: var(--accent-purple);
            transform: scale(1.2);
            cursor: pointer;
        }

        .form-group label:has(input[type="checkbox"]) {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        /* Model select row with download button */
        .model-select-row {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .model-select-row select {
            flex: 1;
        }

        .btn-icon {
            padding: 0.5rem 0.75rem;
            min-width: auto;
        }

        /* Download Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-overlay.show .modal {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .modal-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .download-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            margin-bottom: 0.5rem;
        }

        .download-item-info {
            flex: 1;
        }

        .download-item-info h4 {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .download-item-info p {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .download-item .badge {
            margin-left: 0.5rem;
        }

        /* Image/Video Input Styles */
        .media-input-item {
            display: flex;
            gap: 0.75rem;
            align-items: flex-start;
            padding: 0.75rem;
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            margin-bottom: 0.75rem;
        }

        .media-input-item.has-preview {
            flex-wrap: wrap;
        }

        .media-preview {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            background: var(--bg-hover);
            border: 1px solid var(--border-color);
        }

        .media-input-fields {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-width: 200px;
        }

        .media-input-row {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .media-input-row input[type="file"] {
            flex: 1;
            padding: 0.5rem;
            font-size: 0.875rem;
        }

        .media-input-row input[type="number"] {
            width: 80px;
            padding: 0.5rem;
            font-size: 0.875rem;
        }

        .media-input-row label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .media-remove-btn {
            background: none;
            border: none;
            color: var(--accent-red);
            cursor: pointer;
            padding: 0.25rem;
            font-size: 1.25rem;
            line-height: 1;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .media-remove-btn:hover {
            opacity: 1;
        }

        .pipeline-hint {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .pipeline-hint strong {
            color: var(--accent-purple);
        }

        /* Mode Selector Styles */
        .mode-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .mode-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem 0.75rem;
            background: var(--bg-dark);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .mode-option:hover {
            border-color: var(--accent-purple);
            transform: translateY(-2px);
        }

        .mode-option.selected {
            border-color: var(--accent-purple);
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.15) 0%, rgba(236, 72, 153, 0.1) 100%);
            box-shadow: var(--glow-purple);
        }

        .mode-icon {
            font-size: 1.75rem;
            margin-bottom: 0.5rem;
        }

        .mode-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .mode-desc {
            font-size: 0.7rem;
            color: var(--text-secondary);
            line-height: 1.3;
        }

        .mode-config-summary {
            padding: 0.75rem 1rem;
            background: var(--bg-dark);
            border-radius: 8px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .mode-config-summary strong {
            color: var(--accent-green);
        }

        /* Health Status */
        .health-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .health-item {
            text-align: center;
            padding: 1rem;
            background: var(--bg-dark);
            border-radius: 10px;
        }

        .health-item .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-purple);
        }

        .health-item .label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        /* Presets Dropdown */
        .preset-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .preset-row select {
            flex: 1;
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Animations */
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(168, 85, 247, 0.3); }
            50% { box-shadow: 0 0 40px rgba(236, 72, 153, 0.5); }
        }

        .generating {
            animation: pulse-glow 2s ease-in-out infinite;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .toast {
            padding: 1rem 1.5rem;
            border-radius: 10px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 2rem 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .footer a {
            color: var(--accent-purple);
            text-decoration: none;
        }

        .footer a:hover {
            color: var(--accent-pink);
        }

        /* API Documentation Styles */
        .api-endpoint {
            border: 1px solid var(--border-color);
            border-radius: 10px;
            overflow: hidden;
        }

        .api-endpoint .collapsible-header {
            margin-bottom: 0;
            border-radius: 0;
        }

        .api-endpoint .collapsible-content {
            background: var(--bg-hover);
            border-top: 1px solid var(--border-color);
        }

        .api-endpoint code {
            background: var(--bg-dark);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
        }

        .api-endpoint pre code {
            background: transparent;
            padding: 0;
        }

        .api-endpoint h4 {
            color: var(--text-primary);
            font-size: 0.9rem;
            font-weight: 600;
        }

        .api-endpoint ul {
            line-height: 1.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>üé¨ LTX-2 Video Generation</h1>
            <p>Generate stunning AI videos with Lightricks LTX-2 ‚Ä¢ 4K @ 50 FPS ‚Ä¢ Up to 20 seconds</p>
            <div class="links">
                <a href="/docs" target="_blank">üìö API Docs</a> ‚Ä¢
                <a href="https://huggingface.co/Lightricks/LTX-2" target="_blank">ü§ó HuggingFace</a> ‚Ä¢
                <a href="https://github.com/Lightricks/LTX-2" target="_blank">üêô GitHub</a>
            </div>
        </header>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" data-tab="generate">üé• Generate</div>
            <div class="tab" data-tab="models">üì¶ Models</div>
            <div class="tab" data-tab="presets">üíæ Presets</div>
            <div class="tab" data-tab="api">üìö API</div>
        </div>

        <!-- Toast Container -->
        <div class="toast-container" id="toastContainer"></div>

        <!-- Download Modal -->
        <div class="modal-overlay" id="downloadModal">
            <div class="modal">
                <div class="modal-header">
                    <h3 id="downloadModalTitle">üì¶ Download Models</h3>
                    <button class="modal-close" onclick="hideDownloadModal()">&times;</button>
                </div>
                <div id="downloadModalContent">
                    <!-- Populated dynamically -->
                </div>
            </div>
        </div>

        <!-- Generate Tab -->
        <div class="tab-content" id="generate-tab">
            <div class="main-grid">
                <!-- Left Column - Settings -->
                <div class="left-column">
                    <!-- Preset Selection -->
                    <div class="card">
                        <h2>üíæ Preset</h2>
                        <div class="preset-row">
                            <select id="presetSelect">
                                <option value="">Loading presets...</option>
                            </select>
                            <button class="btn btn-secondary btn-sm" onclick="loadPreset()">Load</button>
                        </div>
                    </div>

                    <!-- Prompt -->
                    <div class="card">
                        <h2>‚ú® Prompt</h2>
                        <div class="form-group">
                            <label for="prompt">Prompt</label>
                            <textarea id="prompt" placeholder="A beautiful sunset over the ocean with waves crashing on the shore..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="negativePrompt">Negative Prompt</label>
                            <textarea id="negativePrompt" style="min-height: 60px" placeholder="blurry, low quality, distorted..."></textarea>
                        </div>
                    </div>

                    <!-- Image/Video Conditioning -->
                    <div class="card">
                        <h2>üñºÔ∏è Image/Video Input</h2>
                        <div class="form-hint" style="margin-bottom: 1rem;">
                            Add images to condition the video generation. Different pipelines use images differently.
                        </div>
                        
                        <!-- Image Inputs -->
                        <div id="imageInputsContainer">
                            <!-- Dynamic image inputs will be added here -->
                        </div>
                        
                        <button class="btn btn-secondary btn-sm" onclick="addImageInput()" style="margin-bottom: 1rem;">
                            ‚ûï Add Image
                        </button>
                        
                        <!-- Video Conditioning (for IC-LoRA) -->
                        <div id="videoConditioningSection" style="display: none;">
                            <hr style="border-color: var(--border-color); margin: 1rem 0;">
                            <h3 style="margin-bottom: 0.5rem;">üé¨ Video Conditioning (IC-LoRA)</h3>
                            <div class="form-hint" style="margin-bottom: 0.5rem;">
                                Upload a control video (depth, pose, edges) for IC-LoRA conditioning.
                            </div>
                            <div id="videoConditioningContainer">
                                <!-- Dynamic video conditioning inputs -->
                            </div>
                            <button class="btn btn-secondary btn-sm" onclick="addVideoConditioning()">
                                ‚ûï Add Video Conditioning
                            </button>
                        </div>
                        
                        <!-- Pipeline-specific hints -->
                        <div class="form-hint pipeline-hint" style="margin-top: 1rem; padding: 0.75rem; background: var(--bg-dark); border-radius: 8px;">
                            <strong id="pipelineHintTitle">üí° Distilled Pipeline:</strong>
                            <span id="pipelineHintText">Use images to set the starting frame or guide the video style.</span>
                        </div>
                    </div>

                    <!-- Settings -->
                    <div class="card">
                        <h2>‚öôÔ∏è Settings</h2>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="height">Height</label>
                                <input type="number" id="height" value="1024" min="256" max="2048" step="64">
                            </div>
                            <div class="form-group">
                                <label for="width">Width</label>
                                <input type="number" id="width" value="1536" min="256" max="2048" step="64">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="numFrames">Frames</label>
                                <input type="number" id="numFrames" value="121" min="9" max="257" step="8">
                            </div>
                            <div class="form-group">
                                <label for="frameRate">FPS</label>
                                <input type="number" id="frameRate" value="24" min="8" max="60">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="numSteps">Inference Steps</label>
                                <input type="number" id="numSteps" value="40" min="4" max="100">
                            </div>
                            <div class="form-group">
                                <label for="cfgScale">CFG Scale</label>
                                <input type="number" id="cfgScale" value="4.0" min="1" max="15" step="0.1">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="seed">Seed (-1 for random)</label>
                            <input type="number" id="seed" value="-1">
                        </div>
                    </div>

                    <!-- Generation Mode Selector -->
                    <div class="card">
                        <h2>üéØ Generation Mode</h2>
                        <div class="mode-selector">
                            <div class="mode-option selected" data-mode="fast" onclick="selectGenerationMode('fast')">
                                <div class="mode-icon">üöÄ</div>
                                <div class="mode-info">
                                    <div class="mode-title">Fast Generation</div>
                                    <div class="mode-desc">8-step distilled, quick results</div>
                                </div>
                            </div>
                            <div class="mode-option" data-mode="quality" onclick="selectGenerationMode('quality')">
                                <div class="mode-icon">üé¨</div>
                                <div class="mode-info">
                                    <div class="mode-title">High Quality</div>
                                    <div class="mode-desc">Two-stage, production ready</div>
                                </div>
                            </div>
                            <div class="mode-option" data-mode="image2video" onclick="selectGenerationMode('image2video')">
                                <div class="mode-icon">üñºÔ∏è</div>
                                <div class="mode-info">
                                    <div class="mode-title">Image to Video</div>
                                    <div class="mode-desc">Animate from reference image</div>
                                </div>
                            </div>
                            <div class="mode-option" data-mode="keyframe" onclick="selectGenerationMode('keyframe')">
                                <div class="mode-icon">üéûÔ∏è</div>
                                <div class="mode-info">
                                    <div class="mode-title">Keyframe Animation</div>
                                    <div class="mode-desc">Interpolate between images</div>
                                </div>
                            </div>
                            <div class="mode-option" data-mode="control" onclick="selectGenerationMode('control')">
                                <div class="mode-icon">üéÆ</div>
                                <div class="mode-info">
                                    <div class="mode-title">Motion Control</div>
                                    <div class="mode-desc">IC-LoRA with depth/pose/edges</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mode-config-summary" id="modeConfigSummary">
                            <strong>‚ö° Config:</strong> <span id="modeConfigText">Distilled Pipeline ‚Ä¢ FP8 Enabled ‚Ä¢ 8 Steps</span>
                        </div>
                    </div>

                    <!-- Advanced Model Settings (Collapsible) -->
                    <div class="card">
                        <div class="collapsible-header" onclick="toggleAdvancedSettings()">
                            <h2 style="margin-bottom: 0;">ü§ñ Advanced Model Settings</h2>
                            <span id="advancedSettingsArrow">‚ñº</span>
                        </div>
                        <div class="collapsible-content" id="advancedSettingsContent">
                            <div class="form-group" style="margin-top: 1rem;">
                                <label for="pipelineType">Pipeline Type</label>
                                <select id="pipelineType">
                                    <option value="distilled">Distilled (Fast, recommended)</option>
                                    <option value="ti2vid_one_stage">Text/Image to Video - One Stage</option>
                                    <option value="ti2vid_two_stages">Text/Image to Video - Two Stages</option>
                                    <option value="ic_lora">IC-LoRA (Image Conditioning)</option>
                                    <option value="keyframe_interpolation">Keyframe Interpolation</option>
                                </select>
                                <div class="form-hint">Choose the generation pipeline. Distilled is fastest, other modes offer more control.</div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="enableFp8">
                                        <input type="checkbox" id="enableFp8" checked style="width: auto; margin-right: 0.5rem;">
                                        Enable FP8 Optimization
                                    </label>
                                    <div class="form-hint">Reduces VRAM usage with minimal quality loss</div>
                                </div>
                                <div class="form-group">
                                    <label for="imageStrength">Image Strength</label>
                                    <input type="number" id="imageStrength" value="1.0" min="0" max="1" step="0.1">
                                    <div class="form-hint">For image-conditioned generation</div>
                                </div>
                            </div>
                        
                            <!-- Model Selection -->
                            <div class="collapsible-header" onclick="toggleModelPaths()" style="margin-top: 1rem;">
                                <span>üîß Model Selection</span>
                                <span id="modelPathsArrow">‚ñº</span>
                            </div>
                            <div class="collapsible-content" id="modelPathsContent">
                                <div class="form-group">
                                    <label for="checkpointSelect">Checkpoint Model</label>
                                    <div class="model-select-row">
                                        <select id="checkpointSelect">
                                            <option value="">Auto-detect (recommended)</option>
                                        </select>
                                        <button class="btn btn-secondary btn-sm btn-icon" onclick="showDownloadModal('checkpoint')" title="Download checkpoint models">
                                            ‚¨áÔ∏è
                                        </button>
                                    </div>
                                    <div class="form-hint">Main model checkpoint. Leave as auto-detect or select a specific model.</div>
                                </div>
                                <div class="form-group">
                                    <label for="upsamplerSelect">Spatial Upsampler</label>
                                    <div class="model-select-row">
                                        <select id="upsamplerSelect">
                                            <option value="">Auto-detect (recommended)</option>
                                        </select>
                                        <button class="btn btn-secondary btn-sm btn-icon" onclick="showDownloadModal('upscaler')" title="Download upsampler models">
                                            ‚¨áÔ∏è
                                        </button>
                                    </div>
                                    <div class="form-hint">Required for distilled and IC-LoRA pipelines.</div>
                                </div>
                                <div class="form-group">
                                    <label for="loraSelect">Distilled LoRA</label>
                                    <div class="model-select-row">
                                        <select id="loraSelect">
                                            <option value="None">None</option>
                                        </select>
                                        <button class="btn btn-secondary btn-sm btn-icon" onclick="showDownloadModal('lora')" title="Download LoRA models">
                                            ‚¨áÔ∏è
                                        </button>
                                    </div>
                                    <div class="form-hint">Required for two-stage and keyframe interpolation pipelines.</div>
                                </div>
                                <div class="form-group">
                                    <label for="gemmaPath">Gemma Model Path</label>
                                    <input type="text" id="gemmaPath" value="./models/gemma" placeholder="./models/gemma">
                                    <div class="form-hint">Path to Gemma text encoder model.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column - Output -->
                <div class="right-column">
                    <!-- Generate Button -->
                    <button class="btn btn-primary btn-block" id="generateBtn" onclick="generateVideo()">
                        üöÄ Generate Video
                    </button>

                    <!-- Status -->
                    <div class="card" id="statusCard" style="display: none; margin-top: 1rem;">
                        <h2>üìä Generation Status</h2>
                        <div id="statusContent"></div>
                        <div class="progress-container" id="progressContainer" style="display: none;">
                            <div class="stages-container" id="stagesContainer">
                                <!-- Stage: Loading Models -->
                                <div class="stage-item pending" id="stageLoading" style="display: none;">
                                    <div class="stage-header">
                                        <span class="stage-name">‚öôÔ∏è Loading Models</span>
                                        <span class="stage-status" id="stageLoadingStatus">Pending</span>
                                    </div>
                                    <div class="stage-bar">
                                        <div class="stage-fill loading" id="stageLoadingFill" style="width: 0%"></div>
                                    </div>
                                    <div class="stage-detail" id="stageLoadingDetail"></div>
                                </div>
                                
                                <!-- Stage 1: Denoising -->
                                <div class="stage-item pending" id="stageDenoising">
                                    <div class="stage-header">
                                        <span class="stage-name">üé® Stage 1: Denoising</span>
                                        <span class="stage-status" id="stageDenoisingStatus">Pending</span>
                                    </div>
                                    <div class="stage-bar">
                                        <div class="stage-fill stage1" id="stageDenoisingFill" style="width: 0%"></div>
                                    </div>
                                    <div class="stage-detail" id="stageDenoisingDetail"></div>
                                </div>
                                
                                <!-- Stage 2: Refinement -->
                                <div class="stage-item pending" id="stageRefinement">
                                    <div class="stage-header">
                                        <span class="stage-name">‚ú® Stage 2: Refinement</span>
                                        <span class="stage-status" id="stageRefinementStatus">Pending</span>
                                    </div>
                                    <div class="stage-bar">
                                        <div class="stage-fill stage2" id="stageRefinementFill" style="width: 0%"></div>
                                    </div>
                                    <div class="stage-detail" id="stageRefinementDetail"></div>
                                </div>
                                
                                <!-- Stage 3: Encoding -->
                                <div class="stage-item pending" id="stageEncoding">
                                    <div class="stage-header">
                                        <span class="stage-name">üé¨ Video Encoding</span>
                                        <span class="stage-status" id="stageEncodingStatus">Pending</span>
                                    </div>
                                    <div class="stage-bar">
                                        <div class="stage-fill encoding" id="stageEncodingFill" style="width: 0%"></div>
                                    </div>
                                    <div class="stage-detail" id="stageEncodingDetail"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Video Output -->
                    <div class="card" style="margin-top: 1rem;">
                        <h2>üé¨ Output</h2>
                        <div class="video-container" id="videoContainer">
                            <div class="video-placeholder">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <p>Your generated video will appear here</p>
                            </div>
                        </div>
                        <div class="btn-group" style="margin-top: 1rem;">
                            <button class="btn btn-secondary btn-sm" id="downloadBtn" style="display: none;" onclick="downloadVideo()">
                                ‚¨áÔ∏è Download
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Models Tab -->
        <div class="tab-content" id="models-tab" style="display: none;">
            <div class="card">
                <h2>üì¶ Model Management</h2>
                <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                    Download models on-demand. Models will be automatically downloaded when needed for generation.
                </p>
                
                <div id="modelsContainer">
                    <div class="status status-info">Loading models...</div>
                </div>
            </div>

            <!-- Health Status -->
            <div class="card">
                <h2>üíª System Status</h2>
                <div class="health-grid" id="healthGrid">
                    <div class="health-item">
                        <div class="value" id="healthCuda">-</div>
                        <div class="label">CUDA</div>
                    </div>
                    <div class="health-item">
                        <div class="value" id="healthGpu">-</div>
                        <div class="label">GPU Memory</div>
                    </div>
                    <div class="health-item">
                        <div class="value" id="healthGenerating">‚ö™</div>
                        <div class="label">Generating</div>
                    </div>
                    <div class="health-item">
                        <div class="value" id="healthPipeline">-</div>
                        <div class="label">Pipeline</div>
                    </div>
                </div>
                <button class="btn btn-secondary btn-sm" style="margin-top: 1rem;" onclick="refreshHealth()">
                    üîÑ Refresh Status
                </button>
            </div>
        </div>

        <!-- Presets Tab -->
        <div class="tab-content" id="presets-tab" style="display: none;">
            <div class="card">
                <h2>üíæ Preset Management</h2>
                
                <!-- Create Preset -->
                <div class="form-group">
                    <label for="newPresetName">Create New Preset</label>
                    <div class="btn-group">
                        <input type="text" id="newPresetName" placeholder="Enter preset name..." style="flex: 1;">
                        <button class="btn btn-primary btn-sm" onclick="createPreset()">Save Current Settings</button>
                    </div>
                </div>

                <hr style="border-color: var(--border-color); margin: 1.5rem 0;">

                <!-- Existing Presets -->
                <h3>Existing Presets</h3>
                <div id="presetsContainer">
                    <div class="status status-info">Loading presets...</div>
                </div>
            </div>
        </div>

        <!-- API Documentation Tab -->
        <div class="tab-content" id="api-tab" style="display: none;">
            <div class="card">
                <h2>üìö REST API Documentation</h2>
                <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                    Full interactive API docs available at <a href="/docs" target="_blank" style="color: var(--accent-purple);">/docs</a> (Swagger UI) 
                    or <a href="/redoc" target="_blank" style="color: var(--accent-pink);">/redoc</a> (ReDoc)
                </p>
                
                <div style="display: grid; gap: 1rem;">
                    <!-- Generate Video (SSE Streaming) -->
                    <div class="api-endpoint">
                        <div class="collapsible-header" onclick="toggleApiSection('api-generate')">
                            <div>
                                <span class="badge" style="background: var(--accent-green); color: white;">POST</span>
                                <code style="margin-left: 0.5rem;">/generate</code>
                                <span style="color: var(--text-secondary); margin-left: 0.5rem;">‚Äî Generate video with SSE streaming</span>
                            </div>
                            <span id="api-generate-arrow">‚ñº</span>
                        </div>
                        <div class="collapsible-content" id="api-generate-content">
                            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                                Generate a video with real-time progress streaming via Server-Sent Events (SSE). Models are auto-downloaded if needed.
                            </p>
                            <h4 style="margin-bottom: 0.5rem;">Request Body</h4>
                            <pre style="background: var(--bg-dark); padding: 1rem; border-radius: 8px; overflow-x: auto; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem;"><code>{
  "preset_name": "default",     // Optional: preset to use
  "prompt": "A sunset...",      // Required if preset has no prompt
  "negative_prompt": "blurry",  // Optional
  "height": 1024,               // 256-2048
  "width": 1536,                // 256-2048
  "num_frames": 121,            // 9-257 (multiples of 8 + 1)
  "frame_rate": 24,             // 8-60
  "num_inference_steps": 40,    // 4-100
  "cfg_guidance_scale": 4.0,    // 1.0-15.0
  "seed": -1,                   // -1 for random
  "input_image_base64": "...",  // Optional: base64 image
  "image_strength": 1.0         // 0.0-1.0
}</code></pre>
                            <h4 style="margin-top: 1rem; margin-bottom: 0.5rem;">SSE Events (text/event-stream)</h4>
                            <ul style="color: var(--text-secondary); margin-left: 1.5rem;">
                                <li><code>init</code> - Job initialized with job_id</li>
                                <li><code>stage</code> - Current stage (loading, stage_1, stage_2, encoding)</li>
                                <li><code>step</code> - Denoising step progress within stage</li>
                                <li><code>complete</code> - Generation finished with download URL</li>
                                <li><code>error</code> - Generation failed with error message</li>
                            </ul>
                            <h4 style="margin-top: 1rem; margin-bottom: 0.5rem;">Example Event Data</h4>
                            <pre style="background: var(--bg-dark); padding: 1rem; border-radius: 8px; overflow-x: auto; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem;"><code>data: {"type": "init", "job_id": "abc123..."}
data: {"type": "stage", "stage": "stage_1", "message": "Stage 1: Generating..."}
data: {"type": "step", "stage": "Stage 1 Denoising", "step": 3, "total": 8, "percentage": 37.5}
data: {"type": "complete", "job_id": "abc123...", "download_url": "/generate/abc123.../download"}</code></pre>
                        </div>
                    </div>

                    <!-- Download Video -->
                    <div class="api-endpoint">
                        <div class="collapsible-header" onclick="toggleApiSection('api-download')">
                            <div>
                                <span class="badge" style="background: var(--accent-purple); color: white;">GET</span>
                                <code style="margin-left: 0.5rem;">/generate/{job_id}/download</code>
                                <span style="color: var(--text-secondary); margin-left: 0.5rem;">‚Äî Download generated video</span>
                            </div>
                            <span id="api-download-arrow">‚ñº</span>
                        </div>
                        <div class="collapsible-content" id="api-download-content">
                            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                                Download the generated video file. Only available when status is <code>completed</code>.
                            </p>
                            <h4 style="margin-bottom: 0.5rem;">Example</h4>
                            <pre style="background: var(--bg-dark); padding: 1rem; border-radius: 8px; overflow-x: auto; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem;"><code>curl http://localhost:8000/generate/abc123/download -o video.mp4</code></pre>
                        </div>
                    </div>

                    <!-- Presets -->
                    <div class="api-endpoint">
                        <div class="collapsible-header" onclick="toggleApiSection('api-presets')">
                            <div>
                                <span class="badge" style="background: var(--accent-purple); color: white;">GET</span>
                                <code style="margin-left: 0.5rem;">/presets</code>
                                <span style="color: var(--text-secondary); margin-left: 0.5rem;">‚Äî List all presets</span>
                            </div>
                            <span id="api-presets-arrow">‚ñº</span>
                        </div>
                        <div class="collapsible-content" id="api-presets-content">
                            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                                Get all available presets with their settings.
                            </p>
                            <h4 style="margin-bottom: 0.5rem;">Related Endpoints</h4>
                            <ul style="color: var(--text-secondary); margin-left: 1.5rem;">
                                <li><code>GET /presets/{name}</code> - Get specific preset</li>
                                <li><code>POST /presets</code> - Create new preset</li>
                                <li><code>PUT /presets/{name}</code> - Update preset</li>
                                <li><code>DELETE /presets/{name}</code> - Delete preset</li>
                                <li><code>POST /presets/{name}/set-default</code> - Set as default</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Models -->
                    <div class="api-endpoint">
                        <div class="collapsible-header" onclick="toggleApiSection('api-models')">
                            <div>
                                <span class="badge" style="background: var(--accent-purple); color: white;">GET</span>
                                <code style="margin-left: 0.5rem;">/models</code>
                                <span style="color: var(--text-secondary); margin-left: 0.5rem;">‚Äî List available models</span>
                            </div>
                            <span id="api-models-arrow">‚ñº</span>
                        </div>
                        <div class="collapsible-content" id="api-models-content">
                            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                                Get all available models with their download status.
                            </p>
                            <h4 style="margin-bottom: 0.5rem;">Download a Model</h4>
                            <pre style="background: var(--bg-dark); padding: 1rem; border-radius: 8px; overflow-x: auto; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem;"><code>curl -X POST http://localhost:8000/models/ltx-2-19b-distilled-fp8/download</code></pre>
                        </div>
                    </div>

                    <!-- Health -->
                    <div class="api-endpoint">
                        <div class="collapsible-header" onclick="toggleApiSection('api-health')">
                            <div>
                                <span class="badge" style="background: var(--accent-purple); color: white;">GET</span>
                                <code style="margin-left: 0.5rem;">/health</code>
                                <span style="color: var(--text-secondary); margin-left: 0.5rem;">‚Äî System health check</span>
                            </div>
                            <span id="api-health-arrow">‚ñº</span>
                        </div>
                        <div class="collapsible-content" id="api-health-content">
                            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                                Check system status: CUDA availability, GPU info, and pipeline status.
                            </p>
                            <h4 style="margin-bottom: 0.5rem;">Response</h4>
                            <pre style="background: var(--bg-dark); padding: 1rem; border-radius: 8px; overflow-x: auto; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem;"><code>{
  "status": "healthy",
  "cuda_available": true,
  "gpu_name": "NVIDIA RTX 4090",
  "gpu_memory_gb": 24.0,
  "pipeline_loaded": true,
  "is_generating": false
}</code></pre>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Python Example -->
            <div class="card">
                <h2>üêç Python Example (SSE Streaming)</h2>
                <pre style="background: var(--bg-dark); padding: 1rem; border-radius: 8px; overflow-x: auto; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem;"><code>import requests
import json

API_URL = "http://localhost:8000"

# Stream generation with real-time progress
response = requests.post(f"{API_URL}/generate", json={
    "prompt": "A majestic eagle soaring over mountains at sunset",
    "height": 1024,
    "width": 1536,
    "num_frames": 121,
    "frame_rate": 24,
    "seed": 42
}, stream=True)

job_id = None
for line in response.iter_lines():
    if line and line.startswith(b"data: "):
        data = json.loads(line[6:])
        
        if data["type"] == "init":
            job_id = data["job_id"]
            print(f"Job started: {job_id}")
        elif data["type"] == "stage":
            print(f"Stage: {data['message']}")
        elif data["type"] == "step":
            print(f"  {data['stage']}: {data['step']}/{data['total']} ({data['percentage']}%)")
        elif data["type"] == "complete":
            print("Generation complete!")
            # Download video
            video = requests.get(f"{API_URL}/generate/{job_id}/download")
            with open("output.mp4", "wb") as f:
                f.write(video.content)
            print("Video saved to output.mp4")
        elif data["type"] == "error":
            print(f"Error: {data['message']}")</code></pre>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <p>Built with ‚ù§Ô∏è for the AI video generation community</p>
            <p><a href="https://github.com/Lightricks/LTX-2">GitHub</a> ‚Ä¢ <a href="https://huggingface.co/Lightricks/LTX-2">HuggingFace</a></p>
        </footer>
    </div>

    <script>
        // API Base URL
        const API_BASE = '';

        // State
        let currentJobId = null;
        let pollInterval = null;
        let presets = [];
        let models = {};

        // Toggle Model Paths Section
        function toggleModelPaths() {
            const content = document.getElementById('modelPathsContent');
            const arrow = document.getElementById('modelPathsArrow');
            content.classList.toggle('show');
            arrow.textContent = content.classList.contains('show') ? '‚ñ≤' : '‚ñº';
        }

        // Toggle Advanced Settings
        function toggleAdvancedSettings() {
            const content = document.getElementById('advancedSettingsContent');
            const arrow = document.getElementById('advancedSettingsArrow');
            content.classList.toggle('show');
            arrow.textContent = content.classList.contains('show') ? '‚ñ≤' : '‚ñº';
        }

        // Toggle API Section
        function toggleApiSection(sectionId) {
            const content = document.getElementById(sectionId + '-content');
            const arrow = document.getElementById(sectionId + '-arrow');
            content.classList.toggle('show');
            arrow.textContent = content.classList.contains('show') ? '‚ñ≤' : '‚ñº';
        }

        // Mode configurations
        const modeConfigs = {
            'fast': {
                pipeline: 'distilled',
                steps: 8,
                fp8: true,
                description: 'Distilled Pipeline ‚Ä¢ FP8 Enabled ‚Ä¢ 8 Steps',
                requiresImage: false,
                requiresLoRA: false
            },
            'quality': {
                pipeline: 'ti2vid_two_stages',
                steps: 40,
                fp8: true,
                description: 'Two-Stage Pipeline ‚Ä¢ 40 Steps ‚Ä¢ 2x Upsampling',
                requiresImage: false,
                requiresLoRA: true
            },
            'image2video': {
                pipeline: 'distilled',
                steps: 8,
                fp8: true,
                description: 'Distilled Pipeline ‚Ä¢ Image Conditioning ‚Ä¢ 8 Steps',
                requiresImage: true,
                requiresLoRA: false
            },
            'keyframe': {
                pipeline: 'keyframe_interpolation',
                steps: 40,
                fp8: true,
                description: 'Keyframe Interpolation ‚Ä¢ Add Start/End Images',
                requiresImage: true,
                requiresLoRA: true
            },
            'control': {
                pipeline: 'ic_lora',
                steps: 8,
                fp8: true,
                description: 'IC-LoRA Pipeline ‚Ä¢ Depth/Pose/Edge Control',
                requiresImage: true,
                requiresLoRA: false
            }
        };

        let currentMode = 'fast';

        function selectGenerationMode(mode) {
            currentMode = mode;
            const config = modeConfigs[mode];
            
            // Update UI selection
            document.querySelectorAll('.mode-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector(`.mode-option[data-mode="${mode}"]`).classList.add('selected');
            
            // Update config summary
            document.getElementById('modeConfigText').textContent = config.description;
            
            // Update pipeline type
            document.getElementById('pipelineType').value = config.pipeline;
            
            // Update steps
            document.getElementById('numSteps').value = config.steps;
            
            // Update FP8
            document.getElementById('enableFp8').checked = config.fp8;
            
            // Show/hide image input section prompt
            if (config.requiresImage) {
                showToast('This mode uses image input. Add images in the Image/Video Input section.', 'info');
            }
            
            // Update pipeline-specific UI
            updatePipelineUI();
        }

        // Get model select value, handling download: prefix
        // For models that need to be downloaded, we store the key so the backend can download on demand
        function getModelSelectValue(selectId) {
            const select = document.getElementById(selectId);
            const value = select.value;
            
            if (!value) return null;
            if (value === 'None') return 'None';
            
            // If it's a download: prefixed value, extract the model key
            // The backend will handle downloading when it doesn't find the file
            if (value.startsWith('download:')) {
                // Return empty so backend uses auto-detection and downloads
                return null;
            }
            
            return value;
        }

        // Handle model select change - offer to download if needed
        function handleModelSelectChange(selectId) {
            const select = document.getElementById(selectId);
            const value = select.value;
            
            if (value && value.startsWith('download:')) {
                const modelKey = value.replace('download:', '');
                showToast(`"${modelKey}" will be auto-downloaded when you generate. Or click the ‚¨áÔ∏è button to download now.`, 'info');
            }
        }

        // ============================================================
        // Image/Video Input Management
        // ============================================================
        
        let imageInputCounter = 0;
        let videoConditioningCounter = 0;

        function addImageInput() {
            const container = document.getElementById('imageInputsContainer');
            const id = `image-input-${imageInputCounter++}`;
            
            const pipelineType = document.getElementById('pipelineType').value;
            const showFrameIndex = pipelineType === 'keyframe_interpolation';
            
            const html = `
                <div class="media-input-item" id="${id}">
                    <img class="media-preview" id="${id}-preview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23606075'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z'/%3E%3C/svg%3E" alt="Preview">
                    <div class="media-input-fields">
                        <div class="media-input-row">
                            <input type="file" id="${id}-file" accept="image/*" onchange="previewImage('${id}')">
                            <button class="media-remove-btn" onclick="removeMediaInput('${id}')" title="Remove">‚úï</button>
                        </div>
                        <div class="media-input-row">
                            <label>Frame:</label>
                            <input type="number" id="${id}-frame" value="0" min="0" title="Frame index where this image applies" ${showFrameIndex ? '' : 'style="display: none;"'}>
                            <label>Strength:</label>
                            <input type="number" id="${id}-strength" value="1.0" min="0" max="1" step="0.1" title="Conditioning strength">
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', html);
        }

        function addVideoConditioning() {
            const container = document.getElementById('videoConditioningContainer');
            const id = `video-cond-${videoConditioningCounter++}`;
            
            const html = `
                <div class="media-input-item" id="${id}">
                    <div class="media-input-fields">
                        <div class="media-input-row">
                            <input type="file" id="${id}-file" accept="video/*,.mp4,.webm,.mov">
                            <label>Strength:</label>
                            <input type="number" id="${id}-strength" value="1.0" min="0" max="1" step="0.1" title="Conditioning strength">
                            <button class="media-remove-btn" onclick="removeMediaInput('${id}')" title="Remove">‚úï</button>
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', html);
        }

        function removeMediaInput(id) {
            const element = document.getElementById(id);
            if (element) {
                element.remove();
            }
        }

        function previewImage(id) {
            const fileInput = document.getElementById(`${id}-file`);
            const preview = document.getElementById(`${id}-preview`);
            
            if (fileInput.files && fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                };
                reader.readAsDataURL(fileInput.files[0]);
            }
        }

        // Update UI based on pipeline type
        function updatePipelineUI() {
            const pipelineType = document.getElementById('pipelineType').value;
            const videoSection = document.getElementById('videoConditioningSection');
            const hintTitle = document.getElementById('pipelineHintTitle');
            const hintText = document.getElementById('pipelineHintText');
            
            // Show/hide video conditioning section for IC-LoRA
            videoSection.style.display = pipelineType === 'ic_lora' ? 'block' : 'none';
            
            // Update frame index visibility in existing image inputs
            const frameInputs = document.querySelectorAll('[id^="image-input-"][id$="-frame"]');
            const showFrame = pipelineType === 'keyframe_interpolation';
            frameInputs.forEach(input => {
                input.style.display = showFrame ? 'inline-block' : 'none';
            });
            
            // Update hint based on pipeline
            const hints = {
                'distilled': { title: 'üí° Distilled Pipeline:', text: 'Use images to set the starting frame or guide the video style.' },
                'ti2vid_one_stage': { title: 'üí° One-Stage Pipeline:', text: 'Images provide initial conditioning for video generation.' },
                'ti2vid_two_stages': { title: 'üí° Two-Stage Pipeline:', text: 'Images guide both generation stages for consistent output.' },
                'ic_lora': { title: 'üí° IC-LoRA Pipeline:', text: 'Use images for initial frames and video conditioning (depth/pose/edges) for motion control.' },
                'keyframe_interpolation': { title: 'üí° Keyframe Interpolation:', text: 'Add images at different frame positions (start=0, end=max_frames) to interpolate between.' }
            };
            
            const hint = hints[pipelineType] || hints['distilled'];
            hintTitle.textContent = hint.title;
            hintText.textContent = hint.text;
        }

        // Collect image inputs for API request
        function collectImageInputs() {
            const images = [];
            const container = document.getElementById('imageInputsContainer');
            const items = container.querySelectorAll('.media-input-item');
            
            items.forEach(item => {
                const id = item.id;
                const fileInput = document.getElementById(`${id}-file`);
                const frameInput = document.getElementById(`${id}-frame`);
                const strengthInput = document.getElementById(`${id}-strength`);
                
                if (fileInput && fileInput.files && fileInput.files[0]) {
                    images.push({
                        file: fileInput.files[0],
                        frame: parseInt(frameInput?.value || 0),
                        strength: parseFloat(strengthInput?.value || 1.0)
                    });
                }
            });
            
            return images;
        }

        // Collect video conditioning for API request
        function collectVideoConditioning() {
            const videos = [];
            const container = document.getElementById('videoConditioningContainer');
            const items = container.querySelectorAll('.media-input-item');
            
            items.forEach(item => {
                const id = item.id;
                const fileInput = document.getElementById(`${id}-file`);
                const strengthInput = document.getElementById(`${id}-strength`);
                
                if (fileInput && fileInput.files && fileInput.files[0]) {
                    videos.push({
                        file: fileInput.files[0],
                        strength: parseFloat(strengthInput?.value || 1.0)
                    });
                }
            });
            
            return videos;
        }

        // Convert file to base64
        async function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1]; // Remove data:...;base64, prefix
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }


        // Download Modal Functions
        function showDownloadModal(modelType) {
            const modal = document.getElementById('downloadModal');
            const content = document.getElementById('downloadModalContent');
            const title = document.getElementById('downloadModalTitle');
            
            const typeNames = {
                'checkpoint': 'Checkpoint Models',
                'upscaler': 'Upsampler Models',
                'lora': 'LoRA Models'
            };
            
            title.textContent = `üì¶ Download ${typeNames[modelType] || 'Models'}`;
            
            // Filter models by type
            const filteredModels = Object.entries(models).filter(([key, model]) => model.type === modelType);
            
            if (filteredModels.length === 0) {
                content.innerHTML = '<div class="status status-info">No models available for this type</div>';
            } else {
                content.innerHTML = filteredModels.map(([key, model]) => `
                    <div class="download-item" id="download-item-${key}">
                        <div class="download-item-info">
                            <h4>${key}</h4>
                            <p>${model.description} ‚Ä¢ ${model.size}</p>
                        </div>
                        ${model.status === 'ready' 
                            ? '<span class="badge badge-ready">‚úÖ Ready</span>'
                            : `<button class="btn btn-primary btn-sm" onclick="downloadModelFromModal('${key}')">‚¨áÔ∏è Download</button>`
                        }
                    </div>
                `).join('');
            }
            
            modal.classList.add('show');
        }

        function hideDownloadModal() {
            document.getElementById('downloadModal').classList.remove('show');
        }

        async function downloadModelFromModal(modelKey) {
            const item = document.getElementById(`download-item-${modelKey}`);
            const button = item.querySelector('button');
            
            if (button) {
                button.disabled = true;
                button.innerHTML = '<span class="spinner"></span> Downloading...';
            }
            
            try {
                showToast(`Starting download: ${modelKey}...`, 'info');
                const result = await apiCall(`/models/${modelKey}/download`, 'POST');
                showToast(result.message || 'Download complete!', 'success');
                
                // Update the item to show "Ready"
                const statusArea = item.querySelector('button') || item.querySelector('.badge');
                if (statusArea) {
                    const badge = document.createElement('span');
                    badge.className = 'badge badge-ready';
                    badge.textContent = '‚úÖ Ready';
                    statusArea.replaceWith(badge);
                }
                
                // Refresh the model selects
                await refreshModelSelects();
                
            } catch (error) {
                showToast(error.message || 'Download failed', 'error');
                if (button) {
                    button.disabled = false;
                    button.innerHTML = '‚¨áÔ∏è Download';
                }
            }
        }

        // Close modal on overlay click
        document.getElementById('downloadModal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                hideDownloadModal();
            }
        });

        // Populate model selection dropdowns
        async function refreshModelSelects() {
            try {
                const modelsData = await apiCall('/models');
                models = modelsData;
                
                const checkpointSelect = document.getElementById('checkpointSelect');
                const upsamplerSelect = document.getElementById('upsamplerSelect');
                const loraSelect = document.getElementById('loraSelect');
                
                // Save current selections
                const currentCheckpoint = checkpointSelect.value;
                const currentUpsampler = upsamplerSelect.value;
                const currentLora = loraSelect.value;
                
                // Clear existing options (except defaults)
                checkpointSelect.innerHTML = '<option value="">Auto-detect (recommended)</option>';
                upsamplerSelect.innerHTML = '<option value="">Auto-detect (recommended)</option>';
                loraSelect.innerHTML = '<option value="None">None</option>';
                
                // Group models by type - all models are selectable (on-demand download)
                // First add downloaded (ready) models
                Object.entries(modelsData).forEach(([key, model]) => {
                    if (model.status === 'ready') {
                        const option = document.createElement('option');
                        option.value = model.path;
                        option.textContent = `‚úÖ ${key} (${model.size})`;
                        option.title = model.description;
                        option.dataset.modelKey = key;
                        
                        if (model.type === 'checkpoint') {
                            checkpointSelect.appendChild(option);
                        } else if (model.type === 'upscaler') {
                            upsamplerSelect.appendChild(option);
                        } else if (model.type === 'lora') {
                            loraSelect.appendChild(option);
                        }
                    }
                });
                
                // Then add not-downloaded models (also selectable - will download on demand)
                Object.entries(modelsData).forEach(([key, model]) => {
                    if (model.status !== 'ready') {
                        const option = document.createElement('option');
                        // Use model key as value for not-downloaded models (will trigger download)
                        option.value = `download:${key}`;
                        option.textContent = `‚¨áÔ∏è ${key} (${model.size} - will download)`;
                        option.title = `${model.description} - Will be downloaded when you generate`;
                        option.dataset.modelKey = key;
                        option.style.color = '#f59e0b'; // Warning/orange color
                        
                        if (model.type === 'checkpoint') {
                            checkpointSelect.appendChild(option);
                        } else if (model.type === 'upscaler') {
                            upsamplerSelect.appendChild(option);
                        } else if (model.type === 'lora') {
                            loraSelect.appendChild(option);
                        }
                    }
                });
                
                // Restore selections if they still exist
                if (currentCheckpoint) {
                    const exists = Array.from(checkpointSelect.options).some(opt => opt.value === currentCheckpoint);
                    if (exists) {
                        checkpointSelect.value = currentCheckpoint;
                    }
                }
                if (currentUpsampler) {
                    const exists = Array.from(upsamplerSelect.options).some(opt => opt.value === currentUpsampler);
                    if (exists) {
                        upsamplerSelect.value = currentUpsampler;
                    }
                }
                if (currentLora) {
                    const exists = Array.from(loraSelect.options).some(opt => opt.value === currentLora);
                    if (exists) {
                        loraSelect.value = currentLora;
                    }
                }
                
            } catch (error) {
                console.error('Failed to refresh model selects:', error);
            }
        }

        // Tab Navigation
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab + '-tab').style.display = 'block';
                
                // Refresh data when switching tabs
                if (tab.dataset.tab === 'models') {
                    refreshModels();
                    refreshHealth();
                } else if (tab.dataset.tab === 'presets') {
                    refreshPresets();
                }
            });
        });

        // Toast Notifications
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast status-${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }

        // API Calls
        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method,
                    headers: { 'Content-Type': 'application/json' }
                };
                if (data) options.body = JSON.stringify(data);
                const response = await fetch(API_BASE + endpoint, options);
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'API Error');
                }
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // Presets
        async function loadPresets() {
            try {
                presets = await apiCall('/presets');
                const select = document.getElementById('presetSelect');
                select.innerHTML = presets.map(p => 
                    `<option value="${p.name}" ${p.is_default ? 'selected' : ''}>${p.name}${p.is_default ? ' (default)' : ''}</option>`
                ).join('');
            } catch (error) {
                showToast('Failed to load presets', 'error');
            }
        }

        async function loadPreset() {
            const name = document.getElementById('presetSelect').value;
            if (!name) return;
            
            try {
                const preset = await apiCall(`/presets/${name}`);
                // Generation settings
                document.getElementById('prompt').value = preset.prompt || '';
                document.getElementById('negativePrompt').value = preset.negative_prompt || '';
                document.getElementById('height').value = preset.height;
                document.getElementById('width').value = preset.width;
                document.getElementById('numFrames').value = preset.num_frames;
                document.getElementById('frameRate').value = preset.frame_rate;
                document.getElementById('numSteps').value = preset.num_inference_steps;
                document.getElementById('cfgScale').value = preset.cfg_guidance_scale;
                document.getElementById('seed').value = preset.seed;
                
                // Model settings
                document.getElementById('pipelineType').value = preset.pipeline_type || 'distilled';
                document.getElementById('enableFp8').checked = preset.enable_fp8 !== false;
                document.getElementById('imageStrength').value = preset.image_strength || 1.0;
                
                // Model selection (set value if it exists in the dropdown, otherwise use auto-detect)
                const checkpointSelect = document.getElementById('checkpointSelect');
                const upsamplerSelect = document.getElementById('upsamplerSelect');
                const loraSelect = document.getElementById('loraSelect');
                
                if (preset.checkpoint_path) {
                    const exists = Array.from(checkpointSelect.options).some(opt => opt.value === preset.checkpoint_path);
                    checkpointSelect.value = exists ? preset.checkpoint_path : '';
                } else {
                    checkpointSelect.value = '';
                }
                
                if (preset.spatial_upsampler_path) {
                    const exists = Array.from(upsamplerSelect.options).some(opt => opt.value === preset.spatial_upsampler_path);
                    upsamplerSelect.value = exists ? preset.spatial_upsampler_path : '';
                } else {
                    upsamplerSelect.value = '';
                }
                
                if (preset.distilled_lora_path && preset.distilled_lora_path !== 'None') {
                    const exists = Array.from(loraSelect.options).some(opt => opt.value === preset.distilled_lora_path);
                    loraSelect.value = exists ? preset.distilled_lora_path : 'None';
                } else {
                    loraSelect.value = 'None';
                }
                
                if (preset.gemma_path !== undefined) {
                    document.getElementById('gemmaPath').value = preset.gemma_path || './models/gemma';
                }
                
                showToast(`Loaded preset: ${name}`, 'success');
            } catch (error) {
                showToast('Failed to load preset', 'error');
            }
        }

        async function createPreset() {
            const name = document.getElementById('newPresetName').value.trim();
            if (!name) {
                showToast('Please enter a preset name', 'warning');
                return;
            }

            try {
                await apiCall('/presets', 'POST', {
                    name,
                    description: 'Created from Web UI',
                    // Generation settings
                    prompt: document.getElementById('prompt').value,
                    negative_prompt: document.getElementById('negativePrompt').value,
                    height: parseInt(document.getElementById('height').value),
                    width: parseInt(document.getElementById('width').value),
                    num_frames: parseInt(document.getElementById('numFrames').value),
                    frame_rate: parseFloat(document.getElementById('frameRate').value),
                    num_inference_steps: parseInt(document.getElementById('numSteps').value),
                    cfg_guidance_scale: parseFloat(document.getElementById('cfgScale').value),
                    seed: parseInt(document.getElementById('seed').value),
                    // Model settings
                    pipeline_type: document.getElementById('pipelineType').value,
                    enable_fp8: document.getElementById('enableFp8').checked,
                    image_strength: parseFloat(document.getElementById('imageStrength').value),
                    // Model selection (handle download: prefix for not-yet-downloaded models)
                    checkpoint_path: getModelSelectValue('checkpointSelect'),
                    spatial_upsampler_path: getModelSelectValue('upsamplerSelect'),
                    distilled_lora_path: getModelSelectValue('loraSelect') || 'None',
                    gemma_path: document.getElementById('gemmaPath').value || './models/gemma'
                });
                showToast(`Created preset: ${name}`, 'success');
                document.getElementById('newPresetName').value = '';
                loadPresets();
                refreshPresets();
            } catch (error) {
                showToast(error.message || 'Failed to create preset', 'error');
            }
        }

        async function refreshPresets() {
            try {
                const presetsData = await apiCall('/presets');
                const container = document.getElementById('presetsContainer');
                
                if (presetsData.length === 0) {
                    container.innerHTML = '<div class="status status-info">No presets found</div>';
                    return;
                }

                container.innerHTML = presetsData.map(p => `
                    <div class="model-item">
                        <div class="model-info">
                            <h4>${p.name} ${p.is_default ? '‚≠ê' : ''}</h4>
                            <p>${p.description || 'No description'}</p>
                        </div>
                        <div class="btn-group">
                            ${!p.is_default ? `<button class="btn btn-secondary btn-sm" onclick="setDefaultPreset('${p.name}')">Set Default</button>` : ''}
                            ${p.name !== 'default' ? `<button class="btn btn-secondary btn-sm" onclick="deletePreset('${p.name}')">üóëÔ∏è</button>` : ''}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                showToast('Failed to refresh presets', 'error');
            }
        }

        async function setDefaultPreset(name) {
            try {
                await apiCall(`/presets/${name}/set-default`, 'POST');
                showToast(`${name} is now the default preset`, 'success');
                loadPresets();
                refreshPresets();
            } catch (error) {
                showToast('Failed to set default preset', 'error');
            }
        }

        async function deletePreset(name) {
            if (!confirm(`Delete preset "${name}"?`)) return;
            try {
                await apiCall(`/presets/${name}`, 'DELETE');
                showToast(`Deleted preset: ${name}`, 'success');
                loadPresets();
                refreshPresets();
            } catch (error) {
                showToast(error.message || 'Failed to delete preset', 'error');
            }
        }

        // Models
        async function refreshModels() {
            try {
                const data = await apiCall('/models');
                models = data;
                const container = document.getElementById('modelsContainer');
                
                container.innerHTML = Object.entries(data).map(([key, model]) => `
                    <div class="model-item">
                        <div class="model-info">
                            <h4>${key}</h4>
                            <p>${model.description} (${model.size})</p>
                        </div>
                        <div class="model-status">
                            <span class="badge ${model.status === 'ready' ? 'badge-ready' : 'badge-missing'}">
                                ${model.status === 'ready' ? '‚úÖ Ready' : '‚ùå Not Downloaded'}
                            </span>
                            ${model.status !== 'ready' ? `
                                <button class="btn btn-primary btn-sm" onclick="downloadModel('${key}')">
                                    ‚¨áÔ∏è Download
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                showToast('Failed to refresh models', 'error');
            }
        }

        async function downloadModel(modelKey) {
            try {
                showToast(`Starting download: ${modelKey}`, 'info');
                const result = await apiCall(`/models/${modelKey}/download`, 'POST');
                showToast(result.message || 'Download complete!', 'success');
                refreshModels();
            } catch (error) {
                showToast(error.message || 'Download failed', 'error');
            }
        }

        // Health
        async function refreshHealth() {
            try {
                const health = await apiCall('/health');
                document.getElementById('healthCuda').textContent = health.cuda_available ? '‚úÖ' : '‚ùå';
                document.getElementById('healthGpu').textContent = health.gpu_memory_gb ? `${health.gpu_memory_gb} GB` : 'N/A';
                document.getElementById('healthGenerating').textContent = health.is_generating ? 'üü¢' : '‚ö™';
                document.getElementById('healthPipeline').textContent = health.pipeline_loaded ? '‚úÖ' : '‚ùå';
            } catch (error) {
                console.error('Health check failed:', error);
            }
        }


        // Video Generation with SSE Streaming
        let eventSource = null;
        
        // Stage tracking state
        let stageState = {
            loading: { active: false, completed: false, step: 0, total: 0 },
            denoising: { active: false, completed: false, step: 0, total: 8 },
            refinement: { active: false, completed: false, step: 0, total: 3 },
            encoding: { active: false, completed: false, step: 0, total: 3 }
        };
        
        let generationStartTime = null;
        
        function resetStageState() {
            generationStartTime = Date.now();
            stageState = {
                loading: { active: false, completed: false, step: 0, total: 0 },
                denoising: { active: false, completed: false, step: 0, total: 8 },
                refinement: { active: false, completed: false, step: 0, total: 3 },
                encoding: { active: false, completed: false, step: 0, total: 3 }
            };
            
            // Reset UI
            ['Loading', 'Denoising', 'Refinement', 'Encoding'].forEach(stage => {
                const el = document.getElementById(`stage${stage}`);
                const fill = document.getElementById(`stage${stage}Fill`);
                const status = document.getElementById(`stage${stage}Status`);
                const detail = document.getElementById(`stage${stage}Detail`);
                
                if (el) {
                    el.className = 'stage-item pending';
                    if (stage === 'Loading') el.style.display = 'none';
                }
                if (fill) fill.style.width = '0%';
                if (status) { status.textContent = 'Pending'; status.className = 'stage-status'; }
                if (detail) detail.textContent = '';
            });
        }
        
        function updateStageUI(stageName, step, total, percentage, elapsed, remaining, rate) {
            const stageMap = {
                'Loading Models': 'Loading',
                'Stage 1: Denoising': 'Denoising',
                'Stage 2: Refinement': 'Refinement',
                'Video Encoding': 'Encoding'
            };
            
            const stageKey = stageMap[stageName] || stageName;
            const stateKey = stageKey.toLowerCase();
            
            // Show loading stage if it appears
            if (stageKey === 'Loading') {
                document.getElementById('stageLoading').style.display = 'block';
            }
            
            // Mark previous stages as completed (only if they were active before)
            const stageOrder = ['loading', 'denoising', 'refinement', 'encoding'];
            const currentIdx = stageOrder.indexOf(stateKey);
            stageOrder.forEach((s, idx) => {
                // Only mark as completed if:
                // 1. It's before the current stage
                // 2. It was previously active (meaning it ran)
                // 3. It's not already completed
                if (idx < currentIdx && stageState[s].active && !stageState[s].completed) {
                    stageState[s].completed = true;
                    stageState[s].active = false;
                    const el = document.getElementById(`stage${s.charAt(0).toUpperCase() + s.slice(1)}`);
                    const fill = document.getElementById(`stage${s.charAt(0).toUpperCase() + s.slice(1)}Fill`);
                    const status = document.getElementById(`stage${s.charAt(0).toUpperCase() + s.slice(1)}Status`);
                    const detail = document.getElementById(`stage${s.charAt(0).toUpperCase() + s.slice(1)}Detail`);
                    if (el) el.className = 'stage-item completed';
                    if (fill) fill.style.width = '100%';
                    if (status) { status.textContent = '‚úì Complete'; status.className = 'stage-status completed'; }
                    // Preserve final time in detail if stored
                    if (detail && stageState[s].finalTime) {
                        detail.textContent = stageState[s].finalTime;
                    }
                }
            });
            
            // Update current stage
            if (stageState[stateKey]) {
                // If this stage wasn't active before, we're starting fresh
                const wasActive = stageState[stateKey].active;
                
                // If this is the first event for this stage and it's already at 100%,
                // this is likely a timing issue - skip this event for new stages
                if (!wasActive && percentage >= 100) {
                    console.log(`Skipping 100% event for new stage ${stageName}`);
                    return;
                }
                
                stageState[stateKey].active = true;
                stageState[stateKey].step = step;
                stageState[stateKey].total = total;
                
                const el = document.getElementById(`stage${stageKey.charAt(0).toUpperCase() + stageKey.slice(1)}`);
                const fill = document.getElementById(`stage${stageKey.charAt(0).toUpperCase() + stageKey.slice(1)}Fill`);
                const status = document.getElementById(`stage${stageKey.charAt(0).toUpperCase() + stageKey.slice(1)}Status`);
                const detail = document.getElementById(`stage${stageKey.charAt(0).toUpperCase() + stageKey.slice(1)}Detail`);
                
                if (el) el.className = 'stage-item active';
                if (fill) fill.style.width = `${percentage}%`;
                if (status) { status.textContent = `${step}/${total}`; status.className = 'stage-status active'; }
                
                // Build detail text with time info
                let detailText = `Step ${step} of ${total}`;
                if (elapsed) {
                    detailText += ` ‚Ä¢ ${elapsed}`;
                    if (remaining && remaining !== '00:00' && remaining !== '?') {
                        detailText += ` ‚Üí ${remaining} left`;
                    }
                }
                if (rate) {
                    detailText += ` (${rate})`;
                }
                if (detail) detail.textContent = detailText;
                
                // Mark as completed if 100%
                if (percentage >= 100) {
                    stageState[stateKey].completed = true;
                    stageState[stateKey].active = false;
                    // Store final time for display
                    if (elapsed) {
                        stageState[stateKey].finalTime = `Completed in ${elapsed}`;
                        if (detail) detail.textContent = `Completed in ${elapsed}`;
                    }
                    if (el) el.className = 'stage-item completed';
                    if (status) { status.textContent = '‚úì Complete'; status.className = 'stage-status completed'; }
                }
            }
        }
        
        async function generateVideo() {
            const btn = document.getElementById('generateBtn');
            const statusCard = document.getElementById('statusCard');
            const statusContent = document.getElementById('statusContent');
            const progressContainer = document.getElementById('progressContainer');

            const prompt = document.getElementById('prompt').value.trim();
            if (!prompt) {
                showToast('Please enter a prompt', 'warning');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Generating...';
            statusCard.style.display = 'block';
            progressContainer.style.display = 'block';
            
            // Reset stage tracking
            resetStageState();
            
            let pipelineInfo = null;
            let currentStage = null;
            
            // Close any existing event source
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }

            try {
                // Collect image inputs
                const imageInputs = collectImageInputs();
                let inputImageBase64 = null;
                let imageStrength = parseFloat(document.getElementById('imageStrength').value) || 1.0;
                
                // For now, use the first image as the primary conditioning image
                if (imageInputs.length > 0) {
                    statusContent.innerHTML = '<div class="status status-info">Processing image...</div>';
                    inputImageBase64 = await fileToBase64(imageInputs[0].file);
                    imageStrength = imageInputs[0].strength;
                }
                
                // Prepare request body
                const preset = document.getElementById('presetSelect').value;
                const requestBody = {
                    preset_name: preset || null,
                    prompt,
                    negative_prompt: document.getElementById('negativePrompt').value,
                    height: parseInt(document.getElementById('height').value),
                    width: parseInt(document.getElementById('width').value),
                    num_frames: parseInt(document.getElementById('numFrames').value),
                    frame_rate: parseFloat(document.getElementById('frameRate').value),
                    num_inference_steps: parseInt(document.getElementById('numSteps').value),
                    cfg_guidance_scale: parseFloat(document.getElementById('cfgScale').value),
                    seed: parseInt(document.getElementById('seed').value),
                    input_image_base64: inputImageBase64,
                    image_strength: imageStrength
                };
                
                statusContent.innerHTML = '<div class="status status-info">Starting generation...</div>';
                
                // Use fetch with SSE streaming
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to start generation');
                }
                
                // Read the stream
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let pipelineInfo = null;
                let currentStage = null;
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    
                    // Process complete SSE messages
                    const lines = buffer.split('\n\n');
                    buffer = lines.pop() || '';
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                handleProgressEvent(data, btn, statusContent);
                                
                                // Update tracking vars
                                if (data.type === 'info') pipelineInfo = data;
                                if (data.type === 'stage') currentStage = data.stage;
                                if (data.type === 'init') currentJobId = data.job_id;
                                
                                // Exit on completion or error
                                if (data.type === 'complete' || data.type === 'error' || data.type === 'done') {
                                    if (data.type === 'complete') {
                                        // Show video
                                        const videoContainer = document.getElementById('videoContainer');
                                        videoContainer.innerHTML = `<video controls autoplay><source src="/generate/${currentJobId}/download" type="video/mp4"></video>`;
                                        document.getElementById('downloadBtn').style.display = 'inline-flex';
                                    }
                                    btn.disabled = false;
                                    btn.innerHTML = 'üöÄ Generate Video';
                                }
                            } catch (e) {
                                console.error('Parse error:', e, line);
                            }
                        }
                    }
                }

            } catch (error) {
                statusContent.innerHTML = `<div class="status status-error">${error.message || 'Failed to start generation'}</div>`;
                progressContainer.style.display = 'none';
                btn.disabled = false;
                btn.innerHTML = 'üöÄ Generate Video';
            }
        }
        
        function handleProgressEvent(data, btn, statusContent) {
            switch (data.type) {
                case 'init':
                    statusContent.innerHTML = `<div class="status status-info" style="padding: 0.5rem 1rem; font-size: 0.85rem;">üöÄ Generating video...</div>`;
                    break;
                    
                case 'info':
                    // Store pipeline info in a compact display
                    const infoHtml = `
                        <div class="status status-info" style="padding: 0.5rem 1rem; font-size: 0.85rem;">
                            üé¨ ${data.pipeline} ‚Ä¢ ${data.resolution} ‚Ä¢ ${data.num_frames} frames
                        </div>`;
                    statusContent.innerHTML = infoHtml;
                    break;
                    
                case 'stage':
                    // Stage events from the API - update status message
                    if (data.stage === 'encoding') {
                        statusContent.innerHTML = `<div class="status status-info" style="padding: 0.5rem 1rem; font-size: 0.85rem;">üìπ Encoding video...</div>`;
                    }
                    break;
                    
                case 'step':
                    // Update individual stage progress using the new UI
                    updateStageUI(data.stage, data.step, data.total, data.percentage, data.elapsed, data.remaining, data.rate);
                    break;
                    
                case 'stage_complete':
                    console.log(`Stage complete: ${data.stage}`);
                    break;
                    
                case 'complete':
                    // Calculate total generation time
                    let totalTimeStr = '';
                    if (generationStartTime) {
                        const totalMs = Date.now() - generationStartTime;
                        const totalSec = Math.floor(totalMs / 1000);
                        const mins = Math.floor(totalSec / 60);
                        const secs = totalSec % 60;
                        totalTimeStr = mins > 0 ? `${mins}m ${secs}s` : `${secs}s`;
                    }
                    
                    // Mark all stages as complete
                    ['Loading', 'Denoising', 'Refinement', 'Encoding'].forEach(stage => {
                        const el = document.getElementById(`stage${stage}`);
                        const fill = document.getElementById(`stage${stage}Fill`);
                        const status = document.getElementById(`stage${stage}Status`);
                        if (el && el.style.display !== 'none' && !el.classList.contains('pending')) {
                            el.className = 'stage-item completed';
                            if (fill) fill.style.width = '100%';
                            if (status) { status.textContent = '‚úì Complete'; status.className = 'stage-status completed'; }
                        }
                    });
                    
                    const successMsg = totalTimeStr 
                        ? `‚úÖ Video generated successfully in ${totalTimeStr}!`
                        : `‚úÖ Video generated successfully!`;
                    statusContent.innerHTML = `<div class="status status-success" style="padding: 0.75rem 1rem;">${successMsg}</div>`;
                    showToast(successMsg, 'success');
                    break;
                    
                case 'error':
                    statusContent.innerHTML = `<div class="status status-error">Failed: ${data.message || 'Unknown error'}</div>`;
                    showToast('Generation failed: ' + (data.message || 'Unknown error'), 'error');
                    break;
                    
                case 'keepalive':
                    // Just a heartbeat, ignore
                    break;
                    
                case 'done':
                    // Generation process finished
                    break;
            }
        }

        function downloadVideo() {
            if (currentJobId) {
                window.open(`/generate/${currentJobId}/download`, '_blank');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadPresets();
            refreshHealth();
            refreshModelSelects();
            
            // Add event listeners to model selects for download notifications
            ['checkpointSelect', 'upsamplerSelect', 'loraSelect'].forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.addEventListener('change', () => handleModelSelectChange(selectId));
                }
            });
            
            // Pipeline type change listener
            document.getElementById('pipelineType').addEventListener('change', updatePipelineUI);
            
            // Initial pipeline UI update
            updatePipelineUI();
        });
    </script>
</body>
</html>
